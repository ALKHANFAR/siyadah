{
  "_meta": {
    "id": "complaint-handling",
    "version": "1.0.0",
    "display_name": "Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰",
    "display_name_en": "Complaint Handling",
    "description": "Ø´ÙƒÙˆÙ‰ ÙˆØµÙ„Øª â†’ ØµÙ†Ù‘ÙÙ‡Ø§ â†’ Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ â†’ Ø³Ø¬Ù‘Ù„Ù‡Ø§ â†’ Ù†Ø¨Ù‘Ù‡ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„",
    "category": "customer_service",
    "industries": [
      "all"
    ],
    "estimated_setup_time": "3 min",
    "user_request_examples": [
      "Ø£Ø¨ÙŠ Ù†Ø¸Ø§Ù… ÙŠØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠ",
      "Ù„Ù…Ø§ Ø¹Ù…ÙŠÙ„ ÙŠØ´ØªÙƒÙŠ Ø£Ø¨ÙŠ Ø£Ø±Ø¯ Ø¹Ù„ÙŠÙ‡ ÙÙˆØ±ÙŠ",
      "Ø³Ùˆ Ù„ÙŠ Ø£ØªÙ…ØªØ© Ù„Ù„Ø´ÙƒØ§ÙˆÙ‰",
      "Ø£Ø¨ÙŠ Ø£Ø¹Ø±Ù Ù„Ù…Ø§ Ø£Ø­Ø¯ ÙŠØ´ØªÙƒÙŠ ÙˆØ£Ø±Ø¯ Ø¹Ù„ÙŠÙ‡",
      "Ø£Ø¨ÙŠ Ù†Ø¸Ø§Ù… Ø´ÙƒØ§ÙˆÙ‰ Ø°ÙƒÙŠ"
    ],
    "intent_keywords": [
      "Ø´ÙƒÙˆÙ‰",
      "Ø´ÙƒØ§ÙˆÙ‰",
      "Ù…Ø´ÙƒÙ„Ø©",
      "ÙŠØ´ØªÙƒÙŠ",
      "complaint",
      "Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡",
      "Ø§Ø³ØªÙŠØ§Ø¡"
    ]
  },
  "trigger": {
    "tool_id": "webhook",
    "action": "catch_webhook",
    "description": "ÙŠØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ù…Ù† Ø§Ù„ÙÙˆØ±Ù… Ø£Ùˆ Ø§Ù„Ø¨ÙˆØª",
    "config": {},
    "expected_output": {
      "customer_name": "{{body.name}}",
      "customer_phone": "{{body.phone}}",
      "customer_email": "{{body.email}}",
      "complaint_text": "{{body.complaint}}",
      "order_number": "{{body.order_number}}"
    },
    "alternative_triggers": [
      "whatsapp-business.new_message",
      "gmail.new_email",
      "google-forms.new_form_response"
    ]
  },
  "steps": [
    {
      "order": 1,
      "id": "format_phone",
      "tool_id": "code",
      "action": "run_javascript",
      "description": "ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„",
      "config": {
        "code": "const phone = (inputs.phone || '').replace(/^0/, '+966').replace(/^966/, '+966').replace(/^00966/, '+966'); return { formatted_phone: phone, is_valid: /^\\\\+966[0-9]{9}$/.test(phone) };"
      },
      "input_mapping": {
        "phone": "{{trigger.customer_phone}}"
      },
      "on_error": {
        "action": "continue",
        "fallback_value": {
          "formatted_phone": "{{trigger.customer_phone}}",
          "is_valid": false
        }
      }
    },
    {
      "order": 2,
      "id": "classify_complaint",
      "tool_id": "openai",
      "action": "ask_chatgpt",
      "description": "ØªØµÙ†ÙŠÙ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",
      "config": {
        "model": "gpt-4o-mini",
        "temperature": 0.1,
        "response_format": "json_object",
        "system_message": "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØµÙ†ÙŠÙ Ø´ÙƒØ§ÙˆÙ‰. ØµÙ†Ù‘Ù Ø§Ù„Ø´ÙƒÙˆÙ‰ ÙˆØ§Ù‚ØªØ±Ø­ Ø±Ø¯ Ù…Ù†Ø§Ø³Ø¨. Ø±Ø¯ Ø¨Ù€ JSON ÙÙ‚Ø·.",
        "prompt": "ØµÙ†Ù‘Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´ÙƒÙˆÙ‰:\nØ§Ù„Ø¹Ù…ÙŠÙ„: {{trigger.customer_name}}\nØ§Ù„Ø´ÙƒÙˆÙ‰: {{trigger.complaint_text}}\nØ±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: {{trigger.order_number}}\nÙ…Ø¬Ø§Ù„ Ø§Ù„Ø´Ø±ÙƒØ©: {{company.industry}}\n\nØ±Ø¯ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø´ÙƒÙ„ Ø¨Ø§Ù„Ø¶Ø¨Ø·:\n{\"category\": \"ØªØ£Ø®ÙŠØ±|Ø¬ÙˆØ¯Ø©|Ø®Ø¯Ù…Ø©|ÙÙˆØªØ±Ø©|Ø£Ø®Ø±Ù‰\", \"severity\": \"high|medium|low\", \"department\": \"Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„\", \"suggested_response\": \"Ø±Ø¯ Ù…Ù‡Ø°Ø¨ ÙˆÙ…Ø­ØªØ±Ù Ù„Ù„Ø¹Ù…ÙŠÙ„\", \"needs_escalation\": true/false}"
      },
      "output": {
        "category": "string",
        "severity": "high|medium|low",
        "department": "string",
        "suggested_response": "string",
        "needs_escalation": "boolean"
      },
      "on_error": {
        "action": "fallback_rules",
        "fallback": {
          "rules": [
            {
              "if": "complaint_contains:Ø¹Ø§Ø¬Ù„|ÙÙˆØ±ÙŠ|Ø®Ø·ÙŠØ±|Ø³ÙŠØ¡ Ø¬Ø¯Ø§Ù‹|Ø£Ø³ÙˆØ£",
              "then": {
                "severity": "high",
                "needs_escalation": true
              }
            },
            {
              "if": "complaint_contains:ØªØ£Ø®ÙŠØ±|Ù…ØªØ£Ø®Ø±|Ù…Ø§ ÙˆØµÙ„",
              "then": {
                "category": "ØªØ£Ø®ÙŠØ±",
                "severity": "medium"
              }
            },
            {
              "if": "complaint_contains:Ø¬ÙˆØ¯Ø©|Ø³ÙŠØ¡|Ù…ÙƒØ³ÙˆØ±|Ø®Ø±Ø¨Ø§Ù†",
              "then": {
                "category": "Ø¬ÙˆØ¯Ø©",
                "severity": "medium"
              }
            },
            {
              "if": "complaint_contains:ÙØ§ØªÙˆØ±Ø©|Ù…Ø¨Ù„Øº|Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨",
              "then": {
                "category": "ÙÙˆØªØ±Ø©",
                "severity": "medium"
              }
            },
            {
              "if": "default",
              "then": {
                "category": "Ø£Ø®Ø±Ù‰",
                "severity": "low",
                "needs_escalation": false
              }
            }
          ],
          "default_response": "Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙˆØ§ØµÙ„Ùƒ {{customer_name}}. ÙˆØµÙ„ØªÙ†Ø§ Ø´ÙƒÙˆØ§Ùƒ ÙˆØ¨Ù†Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.",
          "log": "âš ï¸ ØªÙ… Ø§Ù„ØªØµÙ†ÙŠÙ Ø¨Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ â€” AI ÙƒØ§Ù† Ù…ØªÙˆÙ‚Ù"
        }
      }
    },
    {
      "order": 3,
      "id": "save_complaint",
      "tool_id": "google-sheets",
      "action": "insert_row",
      "description": "Ø­ÙØ¸ Ø§Ù„Ø´ÙƒÙˆÙ‰ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„",
      "config": {
        "spreadsheet_id": "{{company.complaints_spreadsheet_id}}",
        "sheet_name": "Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰"
      },
      "input_mapping": {
        "values": {
          "Ø±Ù‚Ù…_Ø§Ù„Ø´ÙƒÙˆÙ‰": "CMP-{{context.timestamp_short}}",
          "Ø§Ù„ØªØ§Ø±ÙŠØ®": "{{context.today}}",
          "Ø§Ù„Ø§Ø³Ù…": "{{trigger.customer_name}}",
          "Ø§Ù„Ø¬ÙˆØ§Ù„": "{{step.format_phone.formatted_phone}}",
          "Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„": "{{trigger.customer_email}}",
          "Ø§Ù„Ø´ÙƒÙˆÙ‰": "{{trigger.complaint_text}}",
          "Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨": "{{trigger.order_number}}",
          "Ø§Ù„ØªØµÙ†ÙŠÙ": "{{step.classify_complaint.category}}",
          "Ø§Ù„Ø®Ø·ÙˆØ±Ø©": "{{step.classify_complaint.severity}}",
          "Ø§Ù„Ù‚Ø³Ù…": "{{step.classify_complaint.department}}",
          "Ø§Ù„Ø­Ø§Ù„Ø©": "Ø¬Ø¯ÙŠØ¯Ø©",
          "Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬": ""
        }
      },
      "on_error": {
        "action": "retry_then_alert",
        "retry_count": 3,
        "error_codes": {
          "SPREADSHEET_NOT_FOUND": "auto_create_spreadsheet"
        }
      },
      "critical": true,
      "never_skip": true
    },
    {
      "order": 4,
      "id": "send_acknowledgement",
      "tool_id": "whatsapp-business",
      "action": "send_message",
      "description": "Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙŠØ·Ù…Ù‘Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„",
      "input_mapping": {
        "phone_number": "{{step.format_phone.formatted_phone}}",
        "message": "{{step.classify_complaint.suggested_response || templates.complaint.acknowledgement}}"
      },
      "variable_injection": {
        "customer_name": "{{trigger.customer_name}}",
        "company_name": "{{company.company_name}}",
        "complaint_number": "CMP-{{context.timestamp_short}}",
        "greeting": "{{context.greeting}}"
      },
      "on_error": {
        "action": "fallback_chain",
        "chain": [
          {
            "tool_id": "gmail",
            "action": "send_email",
            "condition": "has_email"
          },
          {
            "tool_id": "twilio",
            "action": "send_sms",
            "condition": "always"
          }
        ]
      },
      "critical": true,
      "never_skip": true
    },
    {
      "order": 5,
      "id": "notify_team",
      "tool_id": "slack",
      "action": "send_message",
      "description": "ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„",
      "input_mapping": {
        "channel": "{{company.notification_channel}}",
        "text": "ðŸš¨ Ø´ÙƒÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©\nðŸ“ Ø±Ù‚Ù…: CMP-{{context.timestamp_short}}\nðŸ‘¤ {{trigger.customer_name}}\nðŸ“± {{step.format_phone.formatted_phone}}\nðŸ’¬ {{trigger.complaint_text}}\nðŸ·ï¸ Ø§Ù„ØªØµÙ†ÙŠÙ: {{step.classify_complaint.category}}\nâš ï¸ Ø§Ù„Ø®Ø·ÙˆØ±Ø©: {{step.classify_complaint.severity}}\nðŸ¢ Ø§Ù„Ù‚Ø³Ù…: {{step.classify_complaint.department}}"
      },
      "on_error": {
        "action": "fallback_chain",
        "chain": [
          {
            "tool_id": "telegram",
            "action": "send_text_message",
            "condition": "telegram_connected"
          },
          {
            "tool_id": "whatsapp-business",
            "action": "send_message",
            "to": "{{company.owner_phone}}",
            "condition": "always"
          },
          {
            "tool_id": "gmail",
            "action": "send_email",
            "to": "{{company.owner_email}}",
            "condition": "always"
          }
        ]
      },
      "critical": true,
      "never_skip": true
    }
  ],
  "branches": [
    {
      "after_step": "classify_complaint",
      "condition_field": "severity",
      "routes": {
        "high": {
          "additional_steps": [
            {
              "id": "urgent_escalation",
              "tool_id": "whatsapp-business",
              "action": "send_message",
              "description": "ØªØµØ¹ÙŠØ¯ Ø¹Ø§Ø¬Ù„ Ù„Ù„Ù…Ø¯ÙŠØ± â€” Ø´ÙƒÙˆÙ‰ Ø®Ø·ÙŠØ±Ø©",
              "input_mapping": {
                "phone_number": "{{company.owner_phone}}",
                "message": "ðŸ”´ Ø´ÙƒÙˆÙ‰ Ø¹Ø§Ø¬Ù„Ø©!\nðŸ‘¤ {{trigger.customer_name}}\nðŸ’¬ {{trigger.complaint_text}}\n\nØªØ­ØªØ§Ø¬ Ø±Ø¯ Ø´Ø®ØµÙŠ Ù…Ù†Ùƒ"
              }
            },
            {
              "id": "mark_as_escalated",
              "tool_id": "google-sheets",
              "action": "update_row",
              "description": "ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰ Ù„Ù€ Ù…ØµØ¹Ù‘Ø¯Ø©",
              "input_mapping": {
                "spreadsheet_id": "{{company.complaints_spreadsheet_id}}",
                "sheet_name": "Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰",
                "lookup_column": "Ø±Ù‚Ù…_Ø§Ù„Ø´ÙƒÙˆÙ‰",
                "lookup_value": "CMP-{{context.timestamp_short}}",
                "values": {
                  "Ø§Ù„Ø­Ø§Ù„Ø©": "Ù…ØµØ¹Ù‘Ø¯Ø©",
                  "Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬": "Ø§Ù„Ù…Ø¯ÙŠØ±"
                }
              }
            }
          ]
        }
      }
    }
  ],
  "delays": [],
  "required_connections": [
    "google-sheets"
  ],
  "recommended_connections": [
    "whatsapp-business",
    "openai",
    "slack",
    "gmail"
  ],
  "minimum_connections": [
    "google-sheets",
    "gmail"
  ],
  "required_variables": {
    "company": [
      "company_name",
      "complaints_spreadsheet_id"
    ],
    "trigger": [
      "customer_name",
      "complaint_text"
    ],
    "optional": [
      "customer_phone",
      "customer_email",
      "order_number"
    ]
  },
  "sheets_template": {
    "name": "Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰",
    "columns": [
      "Ø±Ù‚Ù…_Ø§Ù„Ø´ÙƒÙˆÙ‰",
      "Ø§Ù„ØªØ§Ø±ÙŠØ®",
      "Ø§Ù„Ø§Ø³Ù…",
      "Ø§Ù„Ø¬ÙˆØ§Ù„",
      "Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„",
      "Ø§Ù„Ø´ÙƒÙˆÙ‰",
      "Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨",
      "Ø§Ù„ØªØµÙ†ÙŠÙ",
      "Ø§Ù„Ø®Ø·ÙˆØ±Ø©",
      "Ø§Ù„Ù‚Ø³Ù…",
      "Ø§Ù„Ø­Ø§Ù„Ø©",
      "Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬",
      "ØªØ§Ø±ÙŠØ®_Ø§Ù„Ø­Ù„"
    ]
  },
  "industry_variants": {
    "clinic": {
      "sheets_extra_columns": [
        "Ø§Ù„Ø·Ø¨ÙŠØ¨",
        "Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠ"
      ],
      "classification_extra": "ØµÙ†Ù‘Ù: ÙˆÙ‚Øª Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ø¬ÙˆØ¯Ø© Ø¹Ù„Ø§Ø¬ØŒ ØªØ¹Ø§Ù…Ù„ Ù…ÙˆØ¸ÙÙŠÙ†ØŒ Ù†Ø¸Ø§ÙØ©"
    },
    "ecommerce": {
      "sheets_extra_columns": [
        "Ø§Ù„Ù…Ù†ØªØ¬",
        "Ø±Ù‚Ù… Ø§Ù„Ø´Ø­Ù†Ø©"
      ],
      "classification_extra": "ØµÙ†Ù‘Ù: ØªØ£Ø®ÙŠØ± Ø´Ø­Ù†ØŒ Ù…Ù†ØªØ¬ ØªØ§Ù„ÙØŒ Ø®Ø·Ø£ Ø¨Ø§Ù„Ø·Ù„Ø¨ØŒ Ø§Ø³ØªØ±Ø¬Ø§Ø¹"
    },
    "restaurant": {
      "sheets_extra_columns": [
        "Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨",
        "Ø§Ù„ÙØ±Ø¹"
      ],
      "classification_extra": "ØµÙ†Ù‘Ù: Ø¬ÙˆØ¯Ø© Ø·Ø¹Ø§Ù…ØŒ ØªØ£Ø®ÙŠØ±ØŒ Ø®Ø·Ø£ Ø¨Ø§Ù„Ø·Ù„Ø¨ØŒ Ù†Ø¸Ø§ÙØ©"
    }
  },
  "protection": {
    "idempotency": "hash(customer_phone + complaint_text) â€” prevent duplicate complaints",
    "rate_limit": "Max 100 complaints/day per tenant",
    "data_validation": "Complaint text must be > 10 chars, customer name required",
    "circuit_breaker": "3 consecutive failures â†’ queue â†’ alert admin",
    "response_safety": "AI response checked: no offensive language, professional tone, < 300 chars"
  },
  "expected_execution_time": "5-10 seconds",
  "success_criteria": {
    "must": [
      "Complaint recorded in sheet",
      "Customer acknowledged",
      "Team notified"
    ],
    "should": [
      "Complaint classified",
      "High severity escalated"
    ],
    "nice": [
      "AI-generated response used"
    ]
  }
}