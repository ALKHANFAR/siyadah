{
  "_meta": {
    "id": "invoice-collection",
    "version": "1.0.0",
    "display_name": "ØªØ­ØµÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±",
    "display_name_en": "Invoice Collection",
    "description": "ÙØ§ØªÙˆØ±Ø© Ù…ØªØ£Ø®Ø±Ø© â†’ ØªØ°ÙƒÙŠØ± ØªØµØ§Ø¹Ø¯ÙŠ: 3 Ø£ÙŠØ§Ù… â†’ 7 Ø£ÙŠØ§Ù… â†’ 14 ÙŠÙˆÙ… â†’ ØªØµØ¹ÙŠØ¯",
    "category": "invoicing",
    "industries": [
      "all"
    ],
    "estimated_setup_time": "4 min",
    "user_request_examples": [
      "Ø£Ø¨ÙŠ Ø£ØªØ§Ø¨Ø¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©",
      "Ø°ÙƒÙ‘Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù„ÙŠ Ù…Ø§ Ø¯ÙØ¹ÙˆØ§",
      "Ø³Ùˆ Ù„ÙŠ Ù†Ø¸Ø§Ù… ØªØ­ØµÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ",
      "Ø£Ø¨ÙŠ Ø£Ø±Ø³Ù„ ØªØ°ÙƒÙŠØ± Ù„Ù„ÙÙˆØ§ØªÙŠØ±",
      "ÙÙŠÙ‡ Ø¹Ù…Ù„Ø§Ø¡ Ù…ØªØ£Ø®Ø±ÙŠÙ† Ø¨Ø§Ù„Ø¯ÙØ¹"
    ],
    "intent_keywords": [
      "ÙØ§ØªÙˆØ±Ø©",
      "ÙÙˆØ§ØªÙŠØ±",
      "Ø¯ÙØ¹",
      "ØªØ­ØµÙŠÙ„",
      "Ù…ØªØ£Ø®Ø±",
      "ØªØ°ÙƒÙŠØ±",
      "invoice"
    ]
  },
  "trigger": {
    "tool_id": "schedule",
    "action": "every_day",
    "description": "ÙŠØ´ØªØºÙ„ ÙƒÙ„ ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¹Ø© 9 ØµØ¨Ø§Ø­Ø§Ù‹ ÙˆÙŠØªØ´ÙŠÙƒ Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©",
    "config": {
      "hour": 9,
      "minute": 0,
      "timezone": "Asia/Riyadh"
    },
    "alternative_triggers": [
      "schedule.every_week"
    ]
  },
  "steps": [
    {
      "order": 1,
      "id": "fetch_overdue",
      "tool_id": "google-sheets",
      "action": "find_rows",
      "description": "Ø¬Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ù…Ù† Ø§Ù„Ø´ÙŠØª",
      "config": {
        "spreadsheet_id": "{{company.invoices_spreadsheet_id}}",
        "sheet_name": "Ø§Ù„ÙÙˆØ§ØªÙŠØ±"
      },
      "input_mapping": {
        "column_name": "Ø§Ù„Ø­Ø§Ù„Ø©",
        "value": "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©"
      },
      "output": {
        "rows": [],
        "count": 0
      },
      "on_error": {
        "action": "retry_then_alert",
        "retry_count": 3,
        "error_codes": {
          "SPREADSHEET_NOT_FOUND": "auto_create_spreadsheet"
        }
      },
      "critical": true,
      "never_skip": true
    },
    {
      "order": 2,
      "id": "loop_invoices",
      "tool_id": "loop",
      "action": "loop_on_items",
      "description": "Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙ„ ÙØ§ØªÙˆØ±Ø© Ù…ØªØ£Ø®Ø±Ø©",
      "config": {},
      "input_mapping": {
        "items": "{{step.fetch_overdue.rows}}"
      },
      "contains_steps": [
        3,
        4,
        5,
        6
      ],
      "on_error": {
        "action": "log_and_continue"
      }
    },
    {
      "order": 3,
      "id": "format_phone",
      "tool_id": "code",
      "action": "run_javascript",
      "description": "ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„",
      "config": {
        "code": "const phone = (inputs.phone || \"\").replace(/^0/, \"+966\").replace(/^966/, \"+966\"); return { formatted_phone: phone };"
      },
      "input_mapping": {
        "phone": "{{loop.current_item.Ø§Ù„Ø¬ÙˆØ§Ù„}}"
      },
      "on_error": {
        "action": "continue",
        "fallback_value": {
          "formatted_phone": "{{loop.current_item.Ø§Ù„Ø¬ÙˆØ§Ù„}}"
        }
      }
    },
    {
      "order": 4,
      "id": "calculate_days_overdue",
      "tool_id": "code",
      "action": "run_javascript",
      "description": "Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ±",
      "config": {
        "code": "const due = new Date(inputs.due_date); const now = new Date(); const days = Math.floor((now - due) / (1000*60*60*24)); return { days_overdue: days, reminder_level: days <= 3 ? 'gentle' : days <= 7 ? 'firm' : days <= 14 ? 'urgent' : 'escalation' };"
      },
      "input_mapping": {
        "due_date": "{{loop.current_item.ØªØ§Ø±ÙŠØ®_Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚}}"
      },
      "output": {
        "days_overdue": 0,
        "reminder_level": "gentle|firm|urgent|escalation"
      },
      "on_error": {
        "action": "log_and_continue"
      }
    },
    {
      "order": 5,
      "id": "send_reminder",
      "tool_id": "whatsapp-business",
      "action": "send_message",
      "description": "Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± Ø­Ø³Ø¨ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ£Ø®ÙŠØ±",
      "config": {},
      "input_mapping": {
        "phone_number": "{{loop.current_item.Ø§Ù„Ø¬ÙˆØ§Ù„}}",
        "message": "{{templates.invoice.{step.calculate_days_overdue.reminder_level}}}"
      },
      "variable_injection": {
        "customer_name": "{{loop.current_item.Ø§Ù„Ø§Ø³Ù…}}",
        "invoice_number": "{{loop.current_item.Ø±Ù‚Ù…_Ø§Ù„ÙØ§ØªÙˆØ±Ø©}}",
        "amount": "{{loop.current_item.Ø§Ù„Ù…Ø¨Ù„Øº}}",
        "due_date": "{{loop.current_item.ØªØ§Ø±ÙŠØ®_Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚}}",
        "days_overdue": "{{step.calculate_days_overdue.days_overdue}}",
        "company_name": "{{company.company_name}}"
      },
      "on_error": {
        "action": "fallback_chain",
        "chain": [
          {
            "tool_id": "gmail",
            "action": "send_email",
            "condition": "has_email"
          },
          {
            "tool_id": "twilio",
            "action": "send_sms",
            "condition": "always"
          }
        ]
      }
    },
    {
      "order": 6,
      "id": "update_reminder_count",
      "tool_id": "google-sheets",
      "action": "update_row",
      "description": "ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø´ÙŠØª",
      "config": {
        "spreadsheet_id": "{{company.invoices_spreadsheet_id}}",
        "sheet_name": "Ø§Ù„ÙÙˆØ§ØªÙŠØ±"
      },
      "input_mapping": {
        "lookup_column": "Ø±Ù‚Ù…_Ø§Ù„ÙØ§ØªÙˆØ±Ø©",
        "lookup_value": "{{loop.current_item.Ø±Ù‚Ù…_Ø§Ù„ÙØ§ØªÙˆØ±Ø©}}",
        "values": {
          "Ø¹Ø¯Ø¯_Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª": "{{loop.current_item.Ø¹Ø¯Ø¯_Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª + 1}}",
          "Ø¢Ø®Ø±_ØªØ°ÙƒÙŠØ±": "{{context.today}}"
        }
      },
      "on_error": {
        "action": "log_and_continue"
      }
    },
    {
      "order": 7,
      "id": "delay_between_messages",
      "tool_id": "delay",
      "action": "delay_for",
      "description": "ØªØ£Ø®ÙŠØ± Ø¨ÙŠÙ† ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„Ø­Ø¸Ø±",
      "config": {
        "amount": 3,
        "unit": "seconds"
      },
      "on_error": {
        "action": "log_and_continue"
      }
    },
    {
      "order": 8,
      "id": "summary_report",
      "tool_id": "openai",
      "action": "ask_chatgpt",
      "description": "Ù…Ù„Ø®Øµ ÙŠÙˆÙ…ÙŠ Ù„Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©",
      "config": {
        "model": "gpt-4o-mini",
        "temperature": 0.2,
        "prompt": "Ù„Ø®Ù‘Øµ Ù‡Ø°Ù‡ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ø¨Ø´ÙƒÙ„ Ù…Ø®ØªØµØ±:\n{{step.fetch_overdue.rows}}\n\nØ§Ø°ÙƒØ±: Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±ØŒ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„ØºØŒ Ø£Ø®Ø·Ø± Ø§Ù„Ø­Ø§Ù„Ø§Øª. Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©."
      },
      "on_error": {
        "action": "fallback_rules",
        "fallback": {
          "template": "ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: {{step.fetch_overdue.count}} ÙØ§ØªÙˆØ±Ø© Ù…ØªØ£Ø®Ø±Ø©"
        }
      }
    },
    {
      "order": 9,
      "id": "notify_owner_summary",
      "tool_id": "slack",
      "action": "send_message",
      "description": "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø®Øµ Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø´Ø±ÙƒØ©",
      "config": {
        "channel": "{{company.notification_channel}}"
      },
      "input_mapping": {
        "text": "ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ\n{{step.summary_report.response}}"
      },
      "on_error": {
        "action": "fallback_chain",
        "chain": [
          {
            "tool_id": "telegram",
            "action": "send_text_message",
            "condition": "telegram_connected"
          },
          {
            "tool_id": "gmail",
            "action": "send_email",
            "to": "{{company.owner_email}}",
            "condition": "always"
          }
        ]
      }
    }
  ],
  "branches": [
    {
      "after_step": "calculate_days_overdue",
      "condition_field": "reminder_level",
      "routes": {
        "escalation": {
          "additional_steps": [
            {
              "id": "escalation_alert",
              "tool_id": "whatsapp-business",
              "action": "send_message",
              "description": "ØªØµØ¹ÙŠØ¯ Ù„Ù„Ù…Ø¯ÙŠØ± â€” ÙØ§ØªÙˆØ±Ø© Ù…ØªØ£Ø®Ø±Ø© Ø¬Ø¯Ø§Ù‹",
              "input_mapping": {
                "phone_number": "{{company.owner_phone}}",
                "message": "âš ï¸ ØªØµØ¹ÙŠØ¯: ÙØ§ØªÙˆØ±Ø© {{loop.current_item.Ø±Ù‚Ù…_Ø§Ù„ÙØ§ØªÙˆØ±Ø©}} Ù…ØªØ£Ø®Ø±Ø© {{step.calculate_days_overdue.days_overdue}} ÙŠÙˆÙ… â€” Ø§Ù„Ù…Ø¨Ù„Øº: {{loop.current_item.Ø§Ù„Ù…Ø¨Ù„Øº}} Ø±ÙŠØ§Ù„"
              }
            }
          ]
        }
      }
    }
  ],
  "delays": [],
  "required_connections": [
    "google-sheets",
    "schedule"
  ],
  "recommended_connections": [
    "whatsapp-business",
    "openai",
    "slack",
    "gmail"
  ],
  "minimum_connections": [
    "google-sheets",
    "gmail",
    "schedule"
  ],
  "required_variables": {
    "company": [
      "company_name",
      "invoices_spreadsheet_id"
    ],
    "trigger": [],
    "optional": []
  },
  "sheets_template": {
    "name": "Ø§Ù„ÙÙˆØ§ØªÙŠØ±",
    "columns": [
      "Ø±Ù‚Ù…_Ø§Ù„ÙØ§ØªÙˆØ±Ø©",
      "Ø§Ù„Ø§Ø³Ù…",
      "Ø§Ù„Ø¬ÙˆØ§Ù„",
      "Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„",
      "Ø§Ù„Ù…Ø¨Ù„Øº",
      "ØªØ§Ø±ÙŠØ®_Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚",
      "Ø§Ù„Ø­Ø§Ù„Ø©",
      "Ø¹Ø¯Ø¯_Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª",
      "Ø¢Ø®Ø±_ØªØ°ÙƒÙŠØ±"
    ]
  },
  "industry_variants": {
    "clinic": {
      "sheets_extra_columns": [
        "Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©",
        "Ø§Ù„ØªØ£Ù…ÙŠÙ†"
      ],
      "reminder_tone": "Ù…Ù‡Ø°Ø¨ Ø¬Ø¯Ø§Ù‹"
    },
    "construction": {
      "sheets_extra_columns": [
        "Ø§Ù„Ù…Ø±Ø­Ù„Ø©",
        "Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯"
      ],
      "reminder_tone": "Ø±Ø³Ù…ÙŠ"
    },
    "consulting": {
      "sheets_extra_columns": [
        "Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
        "Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„"
      ],
      "reminder_tone": "Ù…Ù‡Ù†ÙŠ"
    }
  },
  "protection": {
    "idempotency": "hash(invoice_number + date) â€” one reminder per invoice per day",
    "rate_limit": "Max 100 reminders/day per tenant",
    "data_validation": "Check invoice exists, amount > 0, phone valid",
    "circuit_breaker": "After 3 WhatsApp failures â†’ switch to email only"
  },
  "expected_execution_time": "30-120 seconds (depends on invoice count)",
  "success_criteria": {
    "must": [
      "Overdue invoices identified",
      "Owner notified with summary"
    ],
    "should": [
      "Reminders sent to customers",
      "Sheet updated"
    ],
    "nice": [
      "AI summary generated"
    ]
  }
}