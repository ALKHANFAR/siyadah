{
  "_meta": {
    "id": "lead-capture",
    "version": "1.0.0",
    "display_name": "Ø¬Ø°Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡",
    "display_name_en": "Lead Capture",
    "description": "Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ ØªÙˆØ§ØµÙ„ â†’ Ø³Ø¬Ù‘Ù„Ù‡ â†’ ØµÙ†Ù‘ÙÙ‡ â†’ Ø±Ø­Ù‘Ø¨ ÙÙŠÙ‡ â†’ Ù†Ø¨Ù‘Ù‡Ù†ÙŠ",
    "category": "sales",
    "industries": [
      "all"
    ],
    "estimated_setup_time": "3 min",
    "user_request_examples": [
      "Ø£Ø¨ÙŠ Ù„Ù…Ø§ ÙŠØ¬ÙŠÙ†ÙŠ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ø£Ø¹Ø±Ù Ø¹Ù†Ù‡",
      "Ø£Ø¨ÙŠ Ø£ØªØ§Ø¨Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯",
      "Ù„Ù…Ø§ Ø£Ø­Ø¯ ÙŠØªÙˆØ§ØµÙ„ Ù…Ø¹ÙŠ Ø£Ø¨ÙŠ Ø£Ø±Ø¯ Ø¹Ù„ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠ",
      "Ø£Ø¨ÙŠ Ù†Ø¸Ø§Ù… ÙŠØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆÙŠØµÙ†Ù‘ÙÙ‡Ù…",
      "Ø³Ùˆ Ù„ÙŠ Ø£ØªÙ…ØªØ© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯"
    ],
    "intent_keywords": [
      "Ø¹Ù…ÙŠÙ„",
      "Ø¬Ø¯ÙŠØ¯",
      "ÙŠØªÙˆØ§ØµÙ„",
      "ÙŠØ¬ÙŠ",
      "lead",
      "Ø§Ø³ØªÙ‚Ø¨Ø§Ù„",
      "ØªØ³Ø¬ÙŠÙ„"
    ]
  },
  "trigger": {
    "tool_id": "webhook",
    "action": "catch_webhook",
    "description": "ÙŠØ³ØªÙ‚Ø¨Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ÙÙˆØ±Ù… Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹",
    "config": {},
    "expected_output": {
      "customer_name": "{{body.name}}",
      "customer_phone": "{{body.phone}}",
      "customer_email": "{{body.email}}",
      "customer_message": "{{body.message}}",
      "customer_source": "{{body.source}}"
    },
    "alternative_triggers": [
      "google-forms.new_form_response",
      "whatsapp-business.new_message",
      "facebook-pages.new_lead"
    ]
  },
  "steps": [
    {
      "order": 1,
      "id": "format_phone",
      "tool_id": "code",
      "action": "run_javascript",
      "description": "ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ù„ØµÙŠØºØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©",
      "config": {
        "code": "const phone = inputs.phone.replace(/^0/, '+966').replace(/^966/, '+966').replace(/^00966/, '+966'); return { formatted_phone: phone, is_valid: /^\\+966[0-9]{9}$/.test(phone) };"
      },
      "input_mapping": {
        "phone": "{{trigger.customer_phone}}"
      },
      "output": {
        "formatted_phone": "+966XXXXXXXXX",
        "is_valid": true
      },
      "on_error": {
        "action": "continue",
        "fallback_value": {
          "formatted_phone": "{{trigger.customer_phone}}",
          "is_valid": false
        }
      }
    },
    {
      "order": 2,
      "id": "save_to_sheet",
      "tool_id": "google-sheets",
      "action": "insert_row",
      "description": "Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
      "config": {
        "spreadsheet_id": "{{company.leads_spreadsheet_id}}",
        "sheet_name": "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡"
      },
      "input_mapping": {
        "values": {
          "Ø§Ù„Ø§Ø³Ù…": "{{trigger.customer_name}}",
          "Ø§Ù„Ø¬ÙˆØ§Ù„": "{{step.format_phone.formatted_phone}}",
          "Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„": "{{trigger.customer_email}}",
          "Ø§Ù„Ø±Ø³Ø§Ù„Ø©": "{{trigger.customer_message}}",
          "Ø§Ù„Ù…ØµØ¯Ø±": "{{trigger.customer_source}}",
          "Ø§Ù„ØªØ§Ø±ÙŠØ®": "{{context.today_hijri}}",
          "Ø§Ù„Ù†ÙˆØ¹": "{{step.classify_lead.lead_type}}",
          "Ø§Ù„Ø­Ø§Ù„Ø©": "Ø¬Ø¯ÙŠØ¯"
        }
      },
      "output": {
        "row_number": 0
      },
      "on_error": {
        "action": "retry_then_alert",
        "retry_count": 3,
        "error_codes": {
          "SPREADSHEET_NOT_FOUND": "auto_create_spreadsheet",
          "COLUMNS_CHANGED": "auto_restore_columns",
          "QUOTA_EXCEEDED": "queue_and_retry_later"
        }
      },
      "critical": true,
      "never_skip": true
    },
    {
      "order": 3,
      "id": "classify_lead",
      "tool_id": "openai",
      "action": "ask_chatgpt",
      "description": "ØªØµÙ†ÙŠÙ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",
      "config": {
        "model": "gpt-4o-mini",
        "temperature": 0.1,
        "response_format": "json_object",
        "system_message": "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØµÙ†ÙŠÙ Ø¹Ù…Ù„Ø§Ø¡. ØµÙ†Ù‘Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„ØªÙ‡. Ø±Ø¯ Ø¨Ù€ JSON ÙÙ‚Ø·.",
        "prompt": "ØµÙ†Ù‘Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„:\nØ§Ù„Ø§Ø³Ù…: {{trigger.customer_name}}\nØ§Ù„Ø±Ø³Ø§Ù„Ø©: {{trigger.customer_message}}\nØ§Ù„Ù…Ø¬Ø§Ù„: {{company.industry}}\n\nØ±Ø¯ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø´ÙƒÙ„ Ø¨Ø§Ù„Ø¶Ø¨Ø·:\n{\"lead_type\": \"hot|warm|cold\", \"service\": \"Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©\", \"priority\": \"high|medium|low\", \"suggested_response\": \"Ø±Ø¯ Ù…Ù‚ØªØ±Ø­ Ù‚ØµÙŠØ±\"}"
      },
      "input_mapping": {},
      "output": {
        "lead_type": "hot|warm|cold",
        "service": "string",
        "priority": "high|medium|low",
        "suggested_response": "string"
      },
      "on_error": {
        "action": "fallback_rules",
        "fallback": {
          "rules": [
            {
              "if": "message_contains:ÙÙŠÙ„Ø§|Ø¨Ù†Ø§Ø¡|Ù…ÙŠØ²Ø§Ù†ÙŠØ©|Ù…ÙˆØ¹Ø¯|Ø¹Ù‚Ø¯|Ø­Ø¬Ø²",
              "then": {
                "lead_type": "hot",
                "priority": "high"
              }
            },
            {
              "if": "message_contains:ÙƒÙ… Ø§Ù„Ø³Ø¹Ø±|Ø¹Ù†Ø¯ÙƒÙ…|Ø£Ø¨ÙŠ Ø£Ø¹Ø±Ù|ÙˆØ´ Ø§Ù„Ø®Ø¯Ù…Ø§Øª",
              "then": {
                "lead_type": "warm",
                "priority": "medium"
              }
            },
            {
              "if": "default",
              "then": {
                "lead_type": "cold",
                "priority": "low"
              }
            }
          ],
          "log": "âš ï¸ ØªÙ… Ø§Ù„ØªØµÙ†ÙŠÙ Ø¨Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ â€” AI ÙƒØ§Ù† Ù…ØªÙˆÙ‚Ù"
        }
      }
    },
    {
      "order": 4,
      "id": "update_sheet_classification",
      "tool_id": "google-sheets",
      "action": "update_row",
      "description": "ØªØ­Ø¯ÙŠØ« ØªØµÙ†ÙŠÙ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø´ÙŠØª",
      "config": {
        "spreadsheet_id": "{{company.leads_spreadsheet_id}}",
        "sheet_name": "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡",
        "row_number": "{{step.save_to_sheet.row_number}}"
      },
      "input_mapping": {
        "values": {
          "Ø§Ù„Ù†ÙˆØ¹": "{{step.classify_lead.lead_type}}",
          "Ø§Ù„Ø®Ø¯Ù…Ø©": "{{step.classify_lead.service}}",
          "Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©": "{{step.classify_lead.priority}}"
        }
      },
      "on_error": {
        "action": "log_and_continue"
      }
    },
    {
      "order": 5,
      "id": "send_welcome",
      "tool_id": "whatsapp-business",
      "action": "send_message",
      "description": "Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ù„Ù„Ø¹Ù…ÙŠÙ„",
      "config": {},
      "input_mapping": {
        "phone_number": "{{step.format_phone.formatted_phone}}",
        "message": "{{templates.welcome.{company.industry}}}"
      },
      "variable_injection": {
        "customer_name": "{{trigger.customer_name}}",
        "company_name": "{{company.company_name}}",
        "greeting": "{{context.greeting}}"
      },
      "on_error": {
        "action": "fallback_chain",
        "chain": [
          {
            "tool_id": "gmail",
            "action": "send_email",
            "condition": "has_email"
          },
          {
            "tool_id": "twilio",
            "action": "send_sms",
            "condition": "always"
          }
        ],
        "error_codes": {
          "INVALID_PHONE": "auto_fix_phone_format",
          "NOT_REGISTERED": "fallback_to_sms",
          "SESSION_EXPIRED": "use_template_message"
        }
      },
      "critical": true,
      "never_skip": true
    },
    {
      "order": 6,
      "id": "notify_owner",
      "tool_id": "slack",
      "action": "send_message",
      "description": "ØªÙ†Ø¨ÙŠÙ‡ ØµØ§Ø­Ø¨ Ø§Ù„Ø´Ø±ÙƒØ©",
      "config": {
        "channel": "{{company.notification_channel}}"
      },
      "input_mapping": {
        "text": "ğŸ”” Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯!\nğŸ‘¤ {{trigger.customer_name}}\nğŸ“± {{step.format_phone.formatted_phone}}\nğŸ“ {{trigger.customer_message}}\nğŸ·ï¸ Ø§Ù„ØªØµÙ†ÙŠÙ: {{step.classify_lead.lead_type}}\nâ­ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: {{step.classify_lead.priority}}"
      },
      "on_error": {
        "action": "fallback_chain",
        "chain": [
          {
            "tool_id": "telegram",
            "action": "send_text_message",
            "condition": "telegram_connected"
          },
          {
            "tool_id": "whatsapp-business",
            "action": "send_message",
            "to": "{{company.owner_phone}}",
            "condition": "always"
          },
          {
            "tool_id": "gmail",
            "action": "send_email",
            "to": "{{company.owner_email}}",
            "condition": "always"
          }
        ]
      },
      "critical": true,
      "never_skip": true
    },
    {
      "order": 7,
      "id": "store_idempotency",
      "tool_id": "storage",
      "action": "store_put",
      "description": "Ø­ÙØ¸ Ù…ÙØªØ§Ø­ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±",
      "config": {},
      "input_mapping": {
        "key": "lead_{{step.format_phone.formatted_phone}}_{{context.today}}",
        "value": {
          "processed": true,
          "timestamp": "{{context.now}}"
        }
      },
      "on_error": {
        "action": "log_and_continue"
      }
    }
  ],
  "branches": [
    {
      "after_step": "classify_lead",
      "condition_field": "lead_type",
      "routes": {
        "hot": {
          "additional_steps": [
            {
              "id": "urgent_alert",
              "tool_id": "whatsapp-business",
              "action": "send_message",
              "description": "ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ø¬Ù„ Ù„Ù„Ù…Ø¯ÙŠØ± â€” Ø¹Ù…ÙŠÙ„ Ø¬Ø§Ø¯",
              "input_mapping": {
                "phone_number": "{{company.owner_phone}}",
                "message": "ğŸ”¥ Ø¹Ù…ÙŠÙ„ Ø¬Ø§Ø¯ Ø§Ù„Ø­ÙŠÙ†!\n{{trigger.customer_name}} â€” {{trigger.customer_message}}\nØ±Ø¯ Ø¹Ù„ÙŠÙ‡ Ø¨Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª"
              }
            }
          ]
        },
        "warm": {
          "additional_steps": []
        },
        "cold": {
          "additional_steps": []
        }
      }
    }
  ],
  "delays": [],
  "required_connections": [
    "google-sheets"
  ],
  "recommended_connections": [
    "whatsapp-business",
    "openai",
    "slack",
    "gmail"
  ],
  "minimum_connections": [
    "google-sheets",
    "gmail"
  ],
  "required_variables": {
    "company": [
      "company_name",
      "industry",
      "leads_spreadsheet_id"
    ],
    "trigger": [
      "customer_name"
    ],
    "optional": [
      "customer_phone",
      "customer_email",
      "customer_message",
      "customer_source"
    ]
  },
  "sheets_template": {
    "name": "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡",
    "columns": [
      "Ø§Ù„Ø§Ø³Ù…",
      "Ø§Ù„Ø¬ÙˆØ§Ù„",
      "Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„",
      "Ø§Ù„Ø±Ø³Ø§Ù„Ø©",
      "Ø§Ù„Ù…ØµØ¯Ø±",
      "Ø§Ù„ØªØ§Ø±ÙŠØ®",
      "Ø§Ù„Ù†ÙˆØ¹",
      "Ø§Ù„Ø®Ø¯Ù…Ø©",
      "Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©",
      "Ø§Ù„Ø­Ø§Ù„Ø©"
    ]
  },
  "industry_variants": {
    "clinic": {
      "sheets_extra_columns": [
        "Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø©",
        "Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"
      ],
      "welcome_template": "templates.welcome.clinic",
      "classification_prompt_extra": "ØµÙ†Ù‘Ù Ø­Ø³Ø¨: Ø§Ø³ØªØ´Ø§Ø±Ø© Ø£ÙˆÙ„Ù‰ØŒ Ù…ØªØ§Ø¨Ø¹Ø©ØŒ Ø·ÙˆØ§Ø±Ø¦"
    },
    "ecommerce": {
      "sheets_extra_columns": [
        "Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨",
        "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©"
      ],
      "welcome_template": "templates.welcome.ecommerce",
      "classification_prompt_extra": "ØµÙ†Ù‘Ù Ø­Ø³Ø¨: Ø´Ø±Ø§Ø¡ ÙÙˆØ±ÙŠØŒ Ø§Ø³ØªÙØ³Ø§Ø±ØŒ Ù…Ù‚Ø§Ø±Ù†Ø© Ø£Ø³Ø¹Ø§Ø±"
    },
    "construction": {
      "sheets_extra_columns": [
        "Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
        "Ø§Ù„Ù…ÙˆÙ‚Ø¹",
        "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©"
      ],
      "welcome_template": "templates.welcome.construction",
      "classification_prompt_extra": "ØµÙ†Ù‘Ù Ø­Ø³Ø¨: Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ØŒ ØµÙŠØ§Ù†Ø©ØŒ Ø§Ø³ØªØ´Ø§Ø±Ø©"
    }
  },
  "protection": {
    "idempotency": "hash(customer_phone + date) â€” prevents duplicate processing",
    "rate_limit": "Max 500 leads/hour per tenant",
    "data_validation": "Phone format check, email format check, required fields check",
    "circuit_breaker": "After 3 consecutive sheet failures â†’ queue leads â†’ alert admin"
  },
  "expected_execution_time": "5-15 seconds",
  "success_criteria": {
    "must": [
      "Data saved to sheet",
      "Owner notified"
    ],
    "should": [
      "Welcome message sent",
      "Lead classified"
    ],
    "nice": [
      "Idempotency key stored"
    ]
  }
}