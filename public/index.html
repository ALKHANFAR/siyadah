<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø³ÙŠØ§Ø¯Ø© | Siyadah â€” Ø£ØªÙ…ØªØ© Ø°ÙƒÙŠØ© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ‘‘</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body,#root{height:100%;overflow:hidden}
body{font-family:'IBM Plex Sans Arabic',system-ui,sans-serif;background:#0A0A0F;color:#E8E8ED}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#1E1E2E;border-radius:4px}
input::placeholder{color:#9494A8;opacity:0.6}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}
@keyframes slideIn{from{opacity:0;transform:translateX(-16px)}to{opacity:1;transform:translateX(0)}}
@keyframes wowSlide{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback} = React;
const T={accent:"#6C5CE7",accentLight:"#A29BFE",success:"#00B894",warn:"#FDCB6E",danger:"#E17055",bg:"#0A0A0F",card:"#12121A",hover:"#1A1A25",text:"#E8E8ED",dim:"#9494A8",border:"#1E1E2E"};
const API = window.location.origin;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Real API calls
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function apiCall(path, body) {
  try {
    const r = await fetch(API + path, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    return await r.json();
  } catch(e) { return {success:false, error:'NETWORK', message:'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±'}; }
}

async function apiGet(path) {
  try {
    const r = await fetch(API + path);
    return await r.json();
  } catch(e) { return {error:'NETWORK'}; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Session
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function useSession() {
  const [session, setSession] = useState(null);
  const register = async (email,password,name) => {
    const r = await apiCall('/api/register', {email,password,name});
    if (r.success) setSession({token:r.token, tenantId:r.tenant.id, user:r.user, plan:r.subscription.plan});
    return r;
  };
  const login = async (email,password) => {
    const r = await apiCall('/api/login', {email,password});
    if (r.success) setSession({token:r.token, tenantId:r.tenantId || r.tenant?.id, user:r.user, plan:r.plan});
    return r;
  };
  const autoRegister = async () => {
    const id = 'demo_' + Date.now() + '@siyadah.app';
    return register(id, 'Demo1234!', 'Ø¹Ø±Ø¶ ØªØ¬Ø±ÙŠØ¨ÙŠ');
  };
  return {session, register, login, autoRegister};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Quick Actions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const QA = [
  {emoji:"ğŸ“¥",label:"Ø¬Ø°Ø¨ Ø¹Ù…Ù„Ø§Ø¡",prompt:"Ø£Ø¨ÙŠ Ù†Ø¸Ø§Ù… Ø¬Ø°Ø¨ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆÙŠØµÙ†ÙÙ‡Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹"},
  {emoji:"ğŸ“",label:"Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¨ÙŠØ¹Ø§Øª",prompt:"Ø£Ø¨ÙŠ Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù„ÙŠ Ù…Ø§ Ø±Ø¯ÙˆØ§"},
  {emoji:"ğŸ“§",label:"Ø­Ù…Ù„Ø© Ø¨Ø±ÙŠØ¯ÙŠØ©",prompt:"Ø£Ø¨ÙŠ Ø­Ù…Ù„Ø© Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯"},
  {emoji:"ğŸ’°",label:"ØªØ°ÙƒÙŠØ± ÙÙˆØ§ØªÙŠØ±",prompt:"Ø£Ø¨ÙŠ Ù†Ø¸Ø§Ù… ØªØ°ÙƒÙŠØ± ÙÙˆØ§ØªÙŠØ± Ù…Ø¹ ØªØµØ¹ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ"},
  {emoji:"ğŸ“…",label:"Ø­Ø¬Ø² Ù…ÙˆØ§Ø¹ÙŠØ¯",prompt:"Ø£Ø¨ÙŠ Ù†Ø¸Ø§Ù… Ø­Ø¬Ø² Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù„Ù„Ø¹ÙŠØ§Ø¯Ø© Ù…Ø¹ ØªØ£ÙƒÙŠØ¯ ÙˆØ§ØªØ³Ø§Ø¨"},
  {emoji:"ğŸ’¬",label:"Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨",prompt:"Ø£Ø¨ÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡"},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Splash
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Splash({onDone}) {
  const [ph,setPh]=useState(0);
  useEffect(()=>{
    const t=[setTimeout(()=>setPh(1),400),setTimeout(()=>setPh(2),1200),setTimeout(()=>setPh(3),2200),setTimeout(()=>onDone(),3000)];
    return ()=>t.forEach(clearTimeout);
  },[onDone]);
  return (
    <div style={{position:"absolute",inset:0,background:T.bg,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",zIndex:9999,transition:"opacity 0.8s",opacity:ph>=3?0:1}}>
      <div style={{width:64,height:64,borderRadius:16,background:`linear-gradient(135deg,${T.accent},${T.success})`,transform:ph>=1?"scale(1)":"scale(0) rotate(-180deg)",transition:"all 0.6s cubic-bezier(0.175,0.885,0.32,1.275)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:28,marginBottom:24,boxShadow:`0 0 60px ${T.accent}40`}}>ğŸ‘‘</div>
      <div style={{fontSize:28,fontWeight:700,color:T.text,opacity:ph>=1?1:0,transition:"all 0.5s ease 0.2s"}}>Ø³ÙŠØ§Ø¯Ø©</div>
      <div style={{fontSize:14,color:T.dim,marginTop:8,opacity:ph>=2?1:0,transition:"all 0.5s ease"}}>Ø§ÙƒØªØ¨. Ø£ØªÙ…Øª. Ø³ÙØ¯.</div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WowMoment Demo
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function WowMoment({onDone, autoRegister}) {
  const [step,setStep]=useState(0);
  const [typed,setTyped]=useState("");
  const [fsteps,setFsteps]=useState([]);
  const [apiResult,setApiResult]=useState(null);
  const mr=useRef(true);
  const full="Ø£Ø¨ÙŠ Ø£ØªØ§Ø¨Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ† Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹";

  useEffect(()=>()=>{mr.current=false},[]);

  // Auto register in background
  useEffect(()=>{ autoRegister(); },[]);

  useEffect(()=>{
    if(step!==1) return;
    let i=0;
    const iv=setInterval(()=>{
      if(!mr.current){clearInterval(iv);return;}
      if(i<=full.length){setTyped(full.slice(0,i));i++;}
      else{clearInterval(iv);setTimeout(()=>{if(mr.current)setStep(2)},600);}
    },45);
    return ()=>clearInterval(iv);
  },[step]);

  useEffect(()=>{
    if(step!==2) return;
    const ss=[
      {icon:"ğŸ””",name:"Webhook",desc:"Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",d:0},
      {icon:"ğŸ¤–",name:"AI ØªØ­Ù„ÙŠÙ„",desc:"ØªØµÙ†ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠ",d:400},
      {icon:"ğŸ“Š",name:"Google Sheets",desc:"Ø­ÙØ¸ ÙÙŠ CRM",d:800},
      {icon:"ğŸ“§",name:"Gmail",desc:"Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨",d:1200},
      {icon:"ğŸ’¬",name:"Slack",desc:"Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ÙØ±ÙŠÙ‚",d:1600},
    ];
    const timers=ss.map(s=>setTimeout(()=>{if(mr.current)setFsteps(p=>[...p,s])},s.d));
    timers.push(setTimeout(()=>{if(mr.current)setStep(3)},2800));
    return ()=>timers.forEach(clearTimeout);
  },[step]);

  return (
    <div style={{position:"absolute",inset:0,background:T.bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:40,zIndex:999}}>
      {step===0&&(
        <div style={{textAlign:"center",animation:"fadeUp 0.5s ease"}}>
          <div style={{fontSize:44,marginBottom:16}}>âœ¨</div>
          <h1 style={{fontSize:26,color:T.text,fontWeight:700,marginBottom:12}}>Ø´ÙˆÙ ÙƒÙŠÙ ÙŠØ´ØªØºÙ„</h1>
          <p style={{fontSize:15,color:T.dim,marginBottom:32,lineHeight:1.6}}>Ø¬Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø© â€” Ù†Ø¸Ø§Ù… Ø£ØªÙ…ØªØ© ÙƒØ§Ù…Ù„</p>
          <button onClick={()=>setStep(1)} style={{background:`linear-gradient(135deg,${T.accent},${T.accentLight})`,color:"#fff",border:"none",borderRadius:12,padding:"14px 40px",fontSize:16,fontWeight:600,cursor:"pointer",boxShadow:`0 4px 24px ${T.accent}40`}}>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø±Ø¶ â†</button>
        </div>
      )}
      {step>=1&&step<3&&(
        <div style={{width:"100%",maxWidth:560}}>
          <div style={{background:T.card,borderRadius:16,padding:20,border:`1px solid ${T.border}`,marginBottom:24}}>
            <div style={{fontSize:12,color:T.dim,marginBottom:12,textAlign:"right"}}>ğŸ’¬ Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ</div>
            <div style={{fontSize:18,color:T.text,direction:"rtl",minHeight:28}}>
              {typed}
              {step===1&&<span style={{display:"inline-block",width:2,height:22,background:T.accent,animation:"blink 0.8s infinite"}}/>}
            </div>
          </div>
          {step>=2&&(
            <div style={{direction:"rtl"}}>
              <div style={{fontSize:13,color:T.success,marginBottom:16,display:"flex",alignItems:"center",gap:6}}>
                <span style={{display:"inline-block",width:8,height:8,borderRadius:"50%",background:T.success,animation:"pulse 1s infinite"}}/>
                Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ù†Ø§Ø¡...
              </div>
              {fsteps.map((s,i)=>(
                <div key={i}>
                  <div style={{display:"flex",alignItems:"center",gap:12,padding:"12px 16px",background:T.card,borderRadius:12,border:`1px solid ${T.border}`,animation:"wowSlide 0.4s ease both"}}>
                    <div style={{width:40,height:40,borderRadius:10,background:T.hover,display:"flex",alignItems:"center",justifyContent:"center",fontSize:18}}>{s.icon}</div>
                    <div style={{flex:1}}><div style={{fontSize:14,fontWeight:600,color:T.text}}>{s.name}</div><div style={{fontSize:12,color:T.dim}}>{s.desc}</div></div>
                    <span style={{fontSize:11,color:T.success}}>âœ“</span>
                  </div>
                  {i<fsteps.length-1&&<div style={{width:2,height:8,background:T.border,marginRight:34}}/>}
                </div>
              ))}
            </div>
          )}
        </div>
      )}
      {step===3&&(
        <div style={{textAlign:"center",animation:"fadeUp 0.4s ease"}}>
          <div style={{fontSize:52,marginBottom:16}}>ğŸ‰</div>
          <h2 style={{fontSize:24,color:T.text,fontWeight:700}}>5 Ø®Ø·ÙˆØ§Øª ÙÙŠ 3 Ø«ÙˆØ§Ù†ÙŠ!</h2>
          <p style={{fontSize:14,color:T.dim,margin:"8px 0 32px"}}>âš¡ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§ÙƒÙ†Ø¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ â€” Ù…Ùˆ Ø¯ÙŠÙ…Ùˆ</p>
          <button onClick={onDone} style={{background:`linear-gradient(135deg,${T.accent},${T.accentLight})`,color:"#fff",border:"none",borderRadius:12,padding:"14px 48px",fontSize:16,fontWeight:600,cursor:"pointer"}}>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
        </div>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Flow Panel (shows REAL backend data)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function FlowPanel({flow,onClose,tenantId}) {
  const [deploying,setDeploying]=useState(false);
  const [deployed,setDeployed]=useState(false);
  const [deployMsg,setDeployMsg]=useState("");

  const doDeploy = async () => {
    setDeploying(true);
    const r = await apiCall('/api/deploy', {tenantId, automationId: flow.automation_id});
    setDeploying(false);
    if(r.success) { setDeployed(true); setDeployMsg(r.message_ar || "Ø´ØºÙ‘Ø§Ù„!"); }
    else { setDeployMsg(r.message || "ÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„"); }
  };

  return (
    <div style={{width:320,background:T.card,overflowY:"auto",padding:20,borderRight:`1px solid ${T.border}`,flexShrink:0,animation:"slideIn 0.3s ease"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
        <h3 style={{fontSize:14,color:T.text,fontWeight:600,margin:0}}>{flow.intent_ar || flow.intent}</h3>
        <button onClick={onClose} style={{background:"transparent",border:"none",color:T.dim,cursor:"pointer",fontSize:18}}>âœ•</button>
      </div>

      {/* Confidence */}
      <div style={{background:T.bg,borderRadius:8,padding:12,marginBottom:16,border:`1px solid ${T.border}`}}>
        <div style={{display:"flex",justifyContent:"space-between",marginBottom:8}}>
          <span style={{fontSize:11,color:T.dim}}>Ø§Ù„Ø«Ù‚Ø©</span>
          <span style={{fontSize:13,fontWeight:700,color:T.success}}>{Math.round((flow.confidence||0.9)*100)}%</span>
        </div>
        <div style={{height:4,borderRadius:2,background:`${T.success}20`}}>
          <div style={{height:"100%",borderRadius:2,background:`linear-gradient(90deg,${T.success},${T.accent})`,width:`${(flow.confidence||0.9)*100}%`,transition:"width 1s"}}/>
        </div>
      </div>

      {/* Trigger */}
      {flow.trigger && (
        <div style={{padding:"10px 12px",borderRadius:10,background:`${T.accent}10`,border:`1px solid ${T.accent}20`,marginBottom:12,fontSize:12,color:T.accentLight}}>
          âš¡ Ø§Ù„Ù…Ø­Ø±Ù‘Ùƒ: <strong>{flow.trigger.piece}</strong> ({flow.trigger.type})
        </div>
      )}

      {/* Steps from REAL API */}
      <div style={{display:"flex",flexDirection:"column",gap:2}}>
        {(flow.steps||[]).map((s,i)=>(
          <div key={i}>
            <div style={{display:"flex",alignItems:"center",gap:10,padding:"10px 12px",borderRadius:10,background:T.bg,border:`1px solid ${T.border}`}}>
              <div style={{width:28,height:28,borderRadius:8,background:T.hover,display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,fontWeight:700,color:T.accent}}>{i+1}</div>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontSize:12,fontWeight:600,color:T.text}}>{s.piece}</div>
                <div style={{fontSize:10,color:T.dim}}>{s.action} â€” {s.role}</div>
              </div>
            </div>
            {i<flow.steps.length-1&&<div style={{width:2,height:10,background:T.border,marginRight:23}}/>}
          </div>
        ))}
      </div>

      {/* Connections Required */}
      {flow.connections_required?.length > 0 && (
        <div style={{marginTop:12,padding:10,borderRadius:8,background:`${T.warn}10`,border:`1px solid ${T.warn}20`,fontSize:11,color:T.warn,lineHeight:1.6}}>
          ğŸ”Œ ÙŠØ­ØªØ§Ø¬ Ø±Ø¨Ø·: {flow.connections_required.join("ØŒ ")}
        </div>
      )}

      {/* Deploy Button */}
      <div style={{display:"flex",gap:8,marginTop:16}}>
        {deployed ? (
          <div style={{flex:1,padding:"10px 0",borderRadius:10,background:`${T.success}15`,textAlign:"center",fontSize:13,fontWeight:600,color:T.success,border:`1px solid ${T.success}30`}}>âœ… {deployMsg}</div>
        ) : (
          <button onClick={doDeploy} disabled={deploying} style={{flex:1,padding:"10px 0",borderRadius:10,background:deploying?T.hover:`linear-gradient(135deg,${T.success},#00A884)`,color:deploying?T.dim:"#fff",border:"none",fontSize:13,fontWeight:600,cursor:deploying?"default":"pointer"}}>
            {deploying ? <span style={{animation:"pulse 0.8s infinite"}}>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„...</span> : "ğŸš€ Ø´ØºÙ‘Ù„ Ø§Ù„Ø¢Ù†"}
          </button>
        )}
      </div>
      {deployMsg && !deployed && <div style={{marginTop:8,fontSize:11,color:T.danger,textAlign:"center"}}>{deployMsg}</div>}

      {/* Validation */}
      {flow.validation && <div style={{marginTop:12,padding:10,borderRadius:8,background:`${T.success}10`,border:`1px solid ${T.success}20`,fontSize:10,color:T.success,lineHeight:1.6}}>âœ“ {flow.validation}</div>}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Chat (REAL API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ChatBuilder({tenantId}) {
  const [msgs,setMsgs]=useState([]);
  const [input,setInput]=useState("");
  const [thinking,setThinking]=useState(false);
  const [activeFlow,setActiveFlow]=useState(null);
  const [showFP,setShowFP]=useState(false);
  const endRef=useRef(null);

  useEffect(()=>{endRef.current?.scrollIntoView({behavior:"smooth"})},[msgs,thinking]);

  const send = async (text) => {
    const clean = (text||input).trim().slice(0,500).replace(/[<>]/g,"");
    if(!clean||thinking) return;
    setInput("");
    setMsgs(p=>[...p,{role:"user",content:clean}]);
    setThinking(true);

    // REAL API CALL
    const result = await apiCall('/api/chat', {tenantId, message: clean});

    if(result.success) {
      setActiveFlow(result);
      setShowFP(true);
      setMsgs(p=>[...p,{
        role:"assistant",
        content: result.message_ar,
        flow: result
      }]);
    } else {
      setMsgs(p=>[...p,{
        role:"assistant",
        content: result.message || result.message_ar || "Ù…Ø§ Ù‚Ø¯Ø±Øª Ø£ÙÙ‡Ù… Ø·Ù„Ø¨Ùƒ â€” Ø¬Ø±Ø¨ ØµÙŠØºØ© Ø«Ø§Ù†ÙŠØ©",
        isError: true
      }]);
    }
    setThinking(false);
  };

  return (
    <div style={{display:"flex",flex:1,direction:"rtl",minHeight:0}}>
      <div style={{flex:1,display:"flex",flexDirection:"column",background:T.bg,minWidth:0}}>
        <div style={{flex:1,overflowY:"auto",padding:"20px",display:"flex",flexDirection:"column",gap:14}}>
          {/* Empty state */}
          {msgs.length===0&&(
            <div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:20,animation:"fadeUp 0.5s ease"}}>
              <div style={{fontSize:42}}>ğŸ‘‘</div>
              <h2 style={{fontSize:20,color:T.text,fontWeight:600,margin:0}}>ÙˆØ´ ØªØ¨ÙŠ ØªØ£ØªÙ…ØªØŸ</h2>
              <p style={{fontSize:13,color:T.dim,textAlign:"center",maxWidth:360,lineHeight:1.7}}>Ø§ÙƒØªØ¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ â€” Ø³ÙŠØ§Ø¯Ø© ÙŠØ¨Ù†ÙŠ Ù†Ø¸Ø§Ù… Ø£ØªÙ…ØªØ© ÙƒØ§Ù…Ù„</p>
              <div style={{display:"flex",alignItems:"center",gap:6,padding:"6px 14px",borderRadius:20,background:`${T.success}12`,border:`1px solid ${T.success}25`}}>
                <span style={{width:6,height:6,borderRadius:"50%",background:T.success}}/>
                <span style={{fontSize:11,color:T.success}}>Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¨Ø§ÙƒÙ†Ø¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</span>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:8,width:"100%",maxWidth:400}}>
                {QA.map((q,i)=>(
                  <button key={i} onClick={()=>send(q.prompt)} style={{background:T.card,border:`1px solid ${T.border}`,borderRadius:12,padding:"12px 8px",cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",gap:6,color:T.text,fontFamily:"inherit"}}>
                    <span style={{fontSize:20}}>{q.emoji}</span>
                    <span style={{fontSize:11,fontWeight:500}}>{q.label}</span>
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Messages */}
          {msgs.map((m,i)=>(
            <div key={i} style={{display:"flex",justifyContent:m.role==="user"?"flex-start":"flex-end",animation:"fadeUp 0.3s ease"}}>
              <div style={{maxWidth:"80%",padding:"12px 16px",borderRadius:m.role==="user"?"16px 16px 4px 16px":"16px 16px 16px 4px",background:m.role==="user"?T.accent:m.isError?`${T.danger}15`:T.card,color:m.role==="user"?"#fff":m.isError?T.danger:T.text,fontSize:14,lineHeight:1.7,border:m.role==="user"?"none":`1px solid ${m.isError?T.danger+"30":T.border}`,whiteSpace:"pre-line"}}>
                {m.content}
                {m.flow&&(
                  <button onClick={()=>{setActiveFlow(m.flow);setShowFP(true)}} style={{display:"block",marginTop:10,padding:"8px 16px",background:`${T.accent}20`,border:`1px solid ${T.accent}40`,borderRadius:8,color:T.accentLight,fontSize:12,cursor:"pointer",fontFamily:"inherit"}}>
                    ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù€ Flow ({m.flow.steps?.length} Ø®Ø·ÙˆØ§Øª)
                  </button>
                )}
              </div>
            </div>
          ))}

          {/* Thinking */}
          {thinking&&(
            <div style={{display:"flex",justifyContent:"flex-end",animation:"fadeUp 0.3s ease"}}>
              <div style={{padding:"12px 20px",borderRadius:"16px 16px 16px 4px",background:T.card,border:`1px solid ${T.border}`,display:"flex",alignItems:"center",gap:8}}>
                <span style={{fontSize:12,color:T.dim}}>ÙŠØ­Ù„Ù„ Ø§Ù„Ø¨Ø§ÙƒÙ†Ø¯</span>
                <div style={{display:"flex",gap:4}}>
                  {[0,1,2].map(j=><div key={j} style={{width:6,height:6,borderRadius:"50%",background:T.accent,animation:`pulse 1s infinite ${j*0.2}s`}}/>)}
                </div>
              </div>
            </div>
          )}
          <div ref={endRef}/>
        </div>

        {/* Input */}
        <div style={{padding:"14px 20px",borderTop:`1px solid ${T.border}`}}>
          <div style={{display:"flex",gap:8,alignItems:"center",background:T.card,borderRadius:14,padding:"4px 4px 4px 14px",border:`1px solid ${T.border}`}}>
            <input value={input} onChange={e=>setInput(e.target.value.slice(0,500))} onKeyDown={e=>e.key==="Enter"&&send()} placeholder="Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ Ù‡Ù†Ø§..." disabled={thinking} maxLength={500} style={{flex:1,background:"transparent",border:"none",color:T.text,fontSize:14,outline:"none",direction:"rtl",opacity:thinking?0.5:1,fontFamily:"inherit"}}/>
            <button onClick={()=>send()} disabled={!input.trim()||thinking} style={{width:38,height:38,borderRadius:10,background:input.trim()&&!thinking?`linear-gradient(135deg,${T.accent},${T.accentLight})`:T.hover,border:"none",cursor:input.trim()&&!thinking?"pointer":"default",display:"flex",alignItems:"center",justifyContent:"center",fontSize:16,color:input.trim()&&!thinking?"#fff":T.dim,flexShrink:0}}>â†‘</button>
          </div>
        </div>
      </div>
      {showFP&&activeFlow&&<FlowPanel flow={activeFlow} onClose={()=>setShowFP(false)} tenantId={tenantId}/>}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Status Panel (REAL health check)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function StatusPanel() {
  const [health,setHealth]=useState(null);
  const [loading,setLoading]=useState(true);
  useEffect(()=>{
    apiGet('/health').then(r=>{setHealth(r);setLoading(false)});
  },[]);

  return (
    <div style={{flex:1,overflowY:"auto",padding:24,direction:"rtl"}}>
      <h2 style={{fontSize:18,color:T.text,fontWeight:600,marginBottom:20}}>Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
      {loading ? (
        <div style={{textAlign:"center",color:T.dim,marginTop:40}}><span style={{animation:"pulse 1s infinite"}}>Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</span></div>
      ) : health?.status === "ok" ? (
        <div>
          <div style={{display:"flex",alignItems:"center",gap:8,padding:16,background:`${T.success}10`,borderRadius:12,border:`1px solid ${T.success}25`,marginBottom:16}}>
            <span style={{width:12,height:12,borderRadius:"50%",background:T.success}}/>
            <span style={{fontSize:14,fontWeight:600,color:T.success}}>Ø§Ù„Ù†Ø¸Ø§Ù… Ø´ØºÙ‘Ø§Ù„ 100%</span>
          </div>
          {Object.entries(health).filter(([k])=>k!=="status").map(([k,v],i)=>(
            <div key={i} style={{display:"flex",justifyContent:"space-between",padding:"10px 16px",background:T.card,borderRadius:10,border:`1px solid ${T.border}`,marginBottom:6}}>
              <span style={{fontSize:12,color:T.dim}}>{k}</span>
              <span style={{fontSize:12,color:T.text,fontWeight:600}}>{String(v)}</span>
            </div>
          ))}
        </div>
      ) : (
        <div style={{padding:16,background:`${T.danger}10`,borderRadius:12,border:`1px solid ${T.danger}25`,color:T.danger,fontSize:14}}>âŒ Ø§Ù„Ø³ÙŠØ±ÙØ± ØºÙŠØ± Ù…ØªØµÙ„</div>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Settings Panel
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function SettingsPanel({session}) {
  return (
    <div style={{flex:1,overflowY:"auto",padding:24,direction:"rtl"}}>
      <h2 style={{fontSize:18,color:T.text,fontWeight:600,marginBottom:20}}>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
      <div style={{background:T.card,borderRadius:14,padding:20,border:`1px solid ${T.border}`,marginBottom:16}}>
        <h3 style={{fontSize:14,fontWeight:600,color:T.text,marginBottom:12}}>ğŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
        <div style={{fontSize:12,color:T.dim,marginBottom:6}}>Tenant: {session?.tenantId}</div>
        <div style={{fontSize:12,color:T.dim,marginBottom:6}}>Ø§Ù„Ø®Ø·Ø©: {session?.plan}</div>
        <div style={{fontSize:12,color:T.dim}}>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {session?.user?.name || session?.user?.email}</div>
      </div>
      <div style={{background:T.card,borderRadius:14,padding:20,border:`1px solid ${T.border}`}}>
        <h3 style={{fontSize:14,fontWeight:600,color:T.text,marginBottom:12}}>ğŸ”— Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h3>
        {[
          {label:"ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…", url:"/health"},
          {label:"ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (568)", url:"/test"},
          {label:"Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", url:"/api/admin"},
        ].map((l,i)=>(
          <a key={i} href={l.url} target="_blank" rel="noopener" style={{display:"block",padding:"10px 14px",background:T.bg,borderRadius:8,border:`1px solid ${T.border}`,marginBottom:6,color:T.accentLight,fontSize:12,textDecoration:"none"}}>{l.label} â† {l.url}</a>
        ))}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sidebar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Sidebar({tab,setTab}) {
  const tabs=[{id:"chat",icon:"ğŸ’¬"},{id:"status",icon:"ğŸ“Š"},{id:"settings",icon:"âš™ï¸"}];
  return (
    <div style={{width:56,background:T.card,borderLeft:`1px solid ${T.border}`,display:"flex",flexDirection:"column",alignItems:"center",paddingTop:16,gap:4,flexShrink:0}}>
      <div style={{width:34,height:34,borderRadius:10,background:`linear-gradient(135deg,${T.accent},${T.success})`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:16,marginBottom:20,boxShadow:`0 2px 12px ${T.accent}30`}}>ğŸ‘‘</div>
      {tabs.map(t=>(
        <button key={t.id} onClick={()=>setTab(t.id)} style={{width:42,height:42,borderRadius:10,background:tab===t.id?`${T.accent}20`:"transparent",border:tab===t.id?`1px solid ${T.accent}40`:"1px solid transparent",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:17,color:T.text}}>{t.icon}</button>
      ))}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// App
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function SiyadahApp() {
  const [splash,setSplash]=useState(true);
  const [wow,setWow]=useState(false);
  const [tab,setTab]=useState("chat");
  const {session,autoRegister}=useSession();
  const splashDone=useCallback(()=>{setSplash(false);setWow(true)},[]);

  return (
    <div style={{height:"100vh",display:"flex",flexDirection:"row-reverse",background:T.bg,color:T.text,overflow:"hidden",fontFamily:"'IBM Plex Sans Arabic',system-ui,sans-serif",position:"relative"}}>
      {splash&&<Splash onDone={splashDone}/>}
      {wow&&<WowMoment onDone={()=>setWow(false)} autoRegister={autoRegister}/>}
      {!splash&&!wow&&(
        <>
          <Sidebar tab={tab} setTab={setTab}/>
          <div style={{flex:1,display:"flex",flexDirection:"column",minWidth:0}}>
            {/* Top bar */}
            <div style={{padding:"8px 20px",background:T.card,borderBottom:`1px solid ${T.border}`,display:"flex",alignItems:"center",justifyContent:"space-between",direction:"rtl"}}>
              <div style={{display:"flex",alignItems:"center",gap:8}}>
                <span style={{fontSize:14,fontWeight:600}}>Ø³ÙŠØ§Ø¯Ø©</span>
                <span style={{fontSize:10,padding:"2px 8px",borderRadius:10,background:`${T.success}15`,color:T.success,border:`1px solid ${T.success}25`}}>API Ø­Ù‚ÙŠÙ‚ÙŠ</span>
              </div>
              <span style={{fontSize:10,color:T.dim}}>{session?.plan || "..."}</span>
            </div>
            {tab==="chat"&&session&&<ChatBuilder tenantId={session.tenantId}/>}
            {tab==="chat"&&!session&&<div style={{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:T.dim}}>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...</div>}
            {tab==="status"&&<StatusPanel/>}
            {tab==="settings"&&<SettingsPanel session={session}/>}
          </div>
        </>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<SiyadahApp/>);
</script>
</body>
</html>
